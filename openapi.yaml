openapi: 3.0.0

info:
  title: Alter Office Analytics API
  version: "1.0.0"
  description: |
    A production-ready analytics tracking API with API-key authentication.
    Includes event collection, summaries, and app registration.

servers:
  - url: https://<your-railway-domain>.up.railway.app
    description: Railway Deployment

tags:
  - name: Auth
    description: App registration & API key generation
  - name: Analytics
    description: Event tracking & summary endpoints

paths:

  ##########################################
  # AUTH: REGISTER APP + GENERATE API KEY
  ##########################################
  /api/auth/register:
    post:
      tags: [Auth]
      summary: Register a new App and generate an API Key
      description: |
        Creates a new app entry in the database and returns a **raw API key**
        (only shown once). The server stores only the **hashed** version.

      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, ownerEmail]
              properties:
                name:
                  type: string
                  example: "My SaaS App"
                ownerEmail:
                  type: string
                  format: email
                  example: "admin@example.com"

      responses:
        "200":
          description: App registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  appId:
                    type: string
                    example: "clu7jk32s0000qz1d0knx4dwv"
                  apiKey:
                    type: string
                    example: "app_live_8alphaPrefix_xxxxxxxxxxxxxxxxxxx"

        "400":
          description: Bad request
        "500":
          description: Server error

  ##########################################
  # ANALYTICS: COLLECT EVENT
  ##########################################
  /api/analytics/collect:
    post:
      tags: [Analytics]
      summary: Collect an analytics event
      description: |
        Records an analytics event for an app using its API key.
        Requires `x-api-key` header for authentication.

      security:
        - ApiKeyAuth: []

      parameters:
        - name: x-api-key
          in: header
          required: true
          description: API key generated during app registration.
          schema:
            type: string
            example: "app_live_12345678_abcdef....."

      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [event]
              properties:
                event:
                  type: string
                  example: "page_view"
                url:
                  type: string
                  example: "https://mysite.com/home"
                referrer:
                  type: string
                  example: "https://google.com"
                device:
                  type: string
                  example: "Mobile Safari on iPhone 14"
                ipAddress:
                  type: string
                  example: "103.22.201.10"
                timestamp:
                  type: string
                  format: date-time
                  example: "2025-01-21T10:20:30Z"
                metadata:
                  type: object
                  example:
                    plan: "premium"
                    experiment: "cta_button_test"
                userId:
                  type: string
                  example: "user_123"

      responses:
        "201":
          description: Event logged successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Event recorded"

        "401":
          description: Invalid or missing API key

        "429":
          description: Rate limit exceeded (Redis limiter)

        "500":
          description: Server error

  ##########################################
  # ANALYTICS: EVENT SUMMARY
  ##########################################
  /api/analytics/event-summary:
    get:
      tags: [Analytics]
      summary: Get analytics event summary
      description: |
        Returns a summary of events for a given time range and event name.

        ⚠️ Requires API key in `x-api-key` header.

      security:
        - ApiKeyAuth: []

      parameters:
        - name: x-api-key
          in: header
          required: true
          schema:
            type: string

        - in: query
          name: event
          required: false
          description: Filter by event name
          schema:
            type: string
            example: "page_view"

        - in: query
          name: startDate
          required: false
          description: Start of date filter
          schema:
            type: string
            format: date
            example: "2025-01-01"

        - in: query
          name: endDate
          required: false
          description: End of date filter
          schema:
            type: string
            format: date
            example: "2025-01-21"

        - in: query
          name: app_id
          required: false
          description: The application ID (if known)
          schema:
            type: string
            example: "clu7jk32s0000qz1d0knx4dwv"

      responses:
        "200":
          description: Event summary retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  totalEvents:
                    type: integer
                    example: 1421
                  uniqueUsers:
                    type: integer
                    example: 312
                  eventsByDate:
                    type: array
                    example:
                      - date: "2025-01-20"
                        count: 120
                      - date: "2025-01-21"
                        count: 98
                additionalProperties: true

        "401":
          description: Unauthorized — API key missing

        "500":
          description: Server error

##########################################
# COMPONENTS
##########################################
components:

  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key
      description: API key required for analytics endpoints.
